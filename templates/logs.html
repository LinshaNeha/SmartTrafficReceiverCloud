<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Logs & Reports</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* --- Added only design styling to match dashboard --- */
    body { 
  background: #0e0e12; 
  color: white; 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  margin: 0; 
}

/* ===== Sidebar ===== */
.sidebar { 
  width: 220px; 
  height: 100vh; 
  position: fixed; 
  top: 0; 
  left: 0; 
  background: #1f1f38;   /* deep navy tone */
  padding: 20px 0 0 0; 
  box-shadow: 2px 0 6px rgba(0, 0, 0, 0.5);
  display: flex;
  flex-direction: column;
  align-items: center;
}

.sidebar h2 { 
  color: #e5e5ee;
  margin: 0 0 30px 0;
  font-size: 20px;
  text-align: center;
}

/* Sidebar Menu */
.sidebar ul { 
  list-style: none; 
  padding: 0; 
  margin: 0; 
  width: 100%;
}

.sidebar li { 
  margin: 8px 0;
}

.sidebar a { 
  color: #cfd0f1; 
  text-decoration: none; 
  display: block; 
  padding: 12px 20px;
  border-radius: 6px;
  font-size: 15px;
  position: relative;       /* needed for pseudo-element */
  transition: all 0.3s ease;
  z-index: 1;               /* ensures text is above ::before */
}

/* ===== Active & Hover States ===== */
.sidebar li.active a {
  position: relative;
  background-color: #2a2a48; /* outer box */
  color: #5a5afc;             /* blue text */
  font-weight: 500;
  z-index: 1;                 /* text above pseudo-element */
}

.sidebar li.active a::before {
  content: "";
  position: absolute;
  inset: 4px;
  background-color: #1f1f38; /* inner dark box */
  border-radius: 6px;
  z-index: -1;               /* behind text */
}

.sidebar a:hover {
  background-color: #2a2a48;
  color: #5a5afc;
}

/* ===== Main Content ===== */
.main { 
  margin-left: 220px; 
  padding: 20px; 
  box-sizing: border-box; 
}

/* ===== Summary Cards ===== */
.summary-cards { 
  display: flex; 
  gap: 20px; 
  margin-bottom: 20px; 
  flex-wrap: wrap; 
}

.card {
  background-color: #1f1f38;
  border-radius: 10px;
  padding: 20px;
  width: 220px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.4);
  text-align: center;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 6px 14px rgba(0,0,0,0.6);
}

/* ===== Charts ===== */
.charts { 
  display: grid; 
  grid-template-columns: 1fr 1fr; 
  gap: 20px; 
  margin-bottom: 20px; 
}

.chart { 
  background: #1e1e2f; 
  padding: 15px; 
  border-radius: 10px; 
}

/* ===== Tables ===== */
table { 
  width: 100%; 
  border-collapse: collapse; 
  margin-bottom: 20px; 
}

th, td { 
  border: 1px solid #555; 
  padding: 5px; 
  vertical-align: top; 
  text-align: center; 
}

pre { 
  white-space: pre-wrap; 
  word-break: break-word; 
  color: #ccc; 
}

/* ===== Headings ===== */
h1,h2,h3 { 
  color: white; 
  margin: 5px 0; 
}

/* ===== Buttons ===== */
button { 
  margin-right: 10px; 
  padding: 8px 12px; 
  background: #4CAF50; 
  border: none; 
  border-radius: 5px; 
  cursor: pointer; 
}

button:hover { 
  background: #45a049; 
}
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Dashboard</h2>
    <ul>
      <li><a href="{{ url_for('index') }}">Overview Panel</a></li>
      <li><a href="{{ url_for('traffic') }}">Traffic Monitor</a></li>
      <li><a href="{{ url_for('ids') }}">Intrusion Detection (AI-IDS)</a></li>
      <li><a href="{{ url_for('qkd') }}">QKD Security</a></li>
      <li><a href="{{ url_for('attack') }}">Attack Simulation</a></li>
      <li class="active"><a href="{{ url_for('logs') }}">Logs & Reports</a></li>
      <li><a href="{{ url_for('settings') }}">Settings</a></li>
    </ul>
  </div>

  <div class="main">
    <section>
      <h1>Logs & Reports</h1>

   

      <!-- Encrypted Traffic Logs -->
      <h2>Encrypted Traffic Logs</h2>
      <table class="data-table">
        <thead>
          <tr><th>Timestamp</th><th>IV</th><th>Ciphertext</th></tr>
        </thead>
        <tbody id="encryptedTraffic"></tbody>
      </table>

      <!-- Visualization -->
      <h2>Visualization (Ciphertext Pattern)</h2>
      <canvas id="cipherChart"></canvas>

      <!-- Action Buttons -->
      <div class="buttons">
        <button onclick="window.print()">üñ®Ô∏è Print Report</button>
        <button onclick="exportLogs('json')">üíæ Export JSON</button>
        <button onclick="exportLogs('csv')">üìä Export CSV</button>
      </div>
    </section>
  </div>

  <script>
    let cipherChart;
    let allLogs = [];

    function visualizeCipher(ciphertext) {
      const values = Array.from(ciphertext).map(c => c.charCodeAt(0) % 256);
      if (cipherChart) cipherChart.destroy();

      const ctx = document.getElementById("cipherChart").getContext("2d");
      cipherChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: values.map((_, i) => i),
          datasets: [{
            label: "Ciphertext Pattern",
            data: values,
            backgroundColor: "rgba(54, 162, 235, 0.6)"
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { x: { display: false }, y: { beginAtZero: true, max: 256 } }
        }
      });
    }

    function renderTable(logs) {
      let tbody = document.getElementById("encryptedTraffic");
      tbody.innerHTML = "";
      logs.forEach((log, index) => {
        const hasError = log.ciphertext.includes("decryption_failed");
        let row = `<tr class="${hasError ? 'highlight-error' : ''}" onclick="visualizeCipher('${log.ciphertext}')">
          <td>${log.received_at}</td>
          <td>${log.iv}</td>
          <td>${log.ciphertext.substring(0, 40)}...</td>
        </tr>`;
        tbody.innerHTML += row;

        if (index === logs.length - 1) visualizeCipher(log.ciphertext);
      });
    }
    ;

    function exportLogs(type) {
      if (type === "json") {
        const blob = new Blob([JSON.stringify(allLogs, null, 2)], { type: "application/json" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "encrypted_logs.json";
        link.click();
      } else if (type === "csv") {
        const rows = [["received_at", "iv", "ciphertext"]];
        allLogs.forEach(l => rows.push([l.received_at, l.iv, l.ciphertext]));
        const csv = rows.map(r => r.join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "encrypted_logs.csv";
        link.click();
      }
    }

    function loadLogs() {
      fetch("/receive_encrypted_data")
        .then(res => res.json())
        .then(data => {
          allLogs = data;
          renderTable(data);
        });
    }

    loadLogs();
    setInterval(loadLogs, 5000);
  </script>
</body>
</html>
