<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Traffic Monitor</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    /* ===== Body ===== */
    body {
      background: linear-gradient(135deg, #0e0e12, #1a1a2b);
      color: #cdd1f9;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      backdrop-filter: blur(2px);
      display: flex; /* Enables fixed sidebar with independent scroll */
      overflow: hidden; /* Prevents body scroll */
    }

    /* ===== Sidebar ===== */
    .sidebar {
      width: 220px;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      background: rgba(31,31,56,0.7);
      padding: 20px 0 0 0;
      box-shadow: 2px 0 20px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      backdrop-filter: blur(10px);
      border-right: 1px solid rgba(255,255,255,0.1);
      z-index: 10;
    }

    .sidebar h2 {
      color: #e5e5ee;
      margin: 0 0 30px 0;
      font-size: 20px;
      text-align: center;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
      width: 100%;
    }

    .sidebar li {
      margin: 8px 0;
    }

    .sidebar a {
      color: #cfd0f1;
      text-decoration: none;
      display: block;
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 15px;
      position: relative;
      transition: all 0.3s ease;
      z-index: 1;
      backdrop-filter: blur(5px);
    }

    .sidebar li.active a {
      background-color: rgba(42,42,72,0.7);
      color: #5a5afc;
      font-weight: 500;
    }

    .sidebar li.active a::before {
      content: "";
      position: absolute;
      inset: 4px;
      background-color: rgba(31,31,56,0.7);
      border-radius: 12px;
      z-index: -1;
    }

    .sidebar a:hover {
      background-color: rgba(42,42,72,0.7);
      color: #5a5afc;
    }

    /* ===== Main Content ===== */
    .main {
      margin-left: 220px;
      padding: 20px;
      box-sizing: border-box;
      height: 100vh;
      overflow-y: auto; /* <-- Allows vertical scrolling for main content */
      width: calc(100% - 220px);
    }

    /* ===== Summary Cards ===== */
    .summary-cards {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .card {
      background: rgba(31,31,56,0.5);
      border-radius: 15px;
      padding: 20px;
      width: 220px;
      box-shadow: 0 8px 32px 0 rgba(0,0,0,0.37);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      text-align: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      color: #cdd1f9;
      font-weight: 500;
      position: relative;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 24px rgba(90,90,252,0.6);
    }

    .card i {
      font-size: 24px;
      margin-bottom: 10px;
    }

    /* ===== Charts ===== */
    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .chart {
      background: rgba(30,30,47,0.5);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.37);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.1);
    }

    /* ===== Tables ===== */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background: rgba(31,31,56,0.5);
      backdrop-filter: blur(8px);
      border-radius: 12px;
      overflow: hidden;
    }

    th, td {
      border: 1px solid rgba(255,255,255,0.1);
      padding: 8px;
      text-align: center;
      font-size: 14px;
      color: #cdd1f9;
    }

    th {
      background: rgba(42,42,72,0.6);
    }

    tbody tr:nth-child(even){
      background: rgba(31,31,56,0.3);
    }

    tbody tr:hover {
      background: rgba(42,42,72,0.5);
    }

    /* ===== Logs JSON Display ===== */
    pre {
      white-space: pre-wrap;
      word-break: break-word;
      color: #7fffd4;
      background: rgba(30,30,47,0.5);
      padding: 10px;
      border-radius: 12px;
      overflow-x: auto;
      backdrop-filter: blur(8px);
    }

    /* ===== Buttons ===== */
    button {
      margin-right: 10px;
      padding: 10px 16px;
      background: rgba(90,90,252,0.6);
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(4px);
    }

    button:hover {
      background: rgba(90,90,252,0.8);
      box-shadow: 0 0 10px rgba(90,90,252,0.7);
    }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Dashboard</h2>
    <ul>
      <li><a href="{{ url_for('index') }}">Overview Panel</a></li>
      <li class="active"><a href="{{ url_for('traffic') }}">Traffic Monitor</a></li>
      <li><a href="{{ url_for('ids') }}">Intrusion Detection (AI-IDS)</a></li>
      <li><a href="{{ url_for('qkd') }}">QKD Security</a></li>
      <li><a href="{{ url_for('attack') }}">Attack Simulation</a></li>
      <li><a href="{{ url_for('logs') }}">Logs & Reports</a></li>
      <li><a href="{{ url_for('settings') }}">Settings</a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main">
    <h1>Traffic Monitor</h1>

    <!-- Summary Cards -->
    <div class="summary-cards">
      <div class="card" id="totalPackets">Total Packets: 0</div>
      <div class="card" id="normalPackets">Normal Packets: 0</div>
      <div class="card" id="attackPackets">Attack Packets: 0</div>
      <div class="card" id="mostUsedProtocol">Most Used Protocol: N/A</div>
    </div>

    <!-- Export Buttons -->
    <button onclick="downloadJSON()">Export JSON</button>
    <button onclick="downloadPDF()">Export PDF</button>

    <!-- Charts -->
    <div class="charts">
      <div class="chart"><h3>Real-time Packet Size</h3><canvas id="lineChart"></canvas></div>
      <div class="chart"><h3>Protocol Distribution</h3><canvas id="protocolChart"></canvas></div>
      <div class="chart"><h3>Attack Categories</h3><canvas id="attackChart"></canvas></div>
      <div class="chart"><h3>Severity Levels</h3><canvas id="severityChart"></canvas></div>
      <div class="chart"><h3>Packet Size Distribution</h3><canvas id="sizeHistogram"></canvas></div>
    </div>

    <!-- Logs -->
    <h3>Logs</h3>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Event ID</th>
          <th>Source IP</th>
          <th>Destination IP</th>
          <th>Protocol</th>
          <th>IDS Score</th>
          <th>Severity</th>
        </tr>
      </thead>
      <tbody id="logs"></tbody>
    </table>
    <pre id="counts"></pre>
  </div>

  <script>
    // --- same JS code as yours ---
    let charts = {};
    let latestData = [];
    const blueShades = [
      "rgba(90,90,252,0.5)","rgba(100,120,255,0.5)","rgba(80,160,255,0.5)",
      "rgba(70,190,255,0.5)","rgba(50,200,255,0.5)","rgba(30,220,255,0.5)",
      "rgba(60,100,255,0.5)","rgba(120,120,255,0.5)"
    ];

    async function fetchTrafficData(){try{
      const res=await fetch("/receive_plain_data");
      const raw=await res.json();
      const data=Array.isArray(raw)?raw.map(r=>r.data||r):(raw.plain||raw.data||[]);
      latestData=data;updateSection(data);
      const counts=countCategories(data);
      const totalPackets=data.length;
      const normalPackets=counts.normal||0;
      const attackPackets=totalPackets-normalPackets;
      const protoCounts={};data.forEach(d=>{const proto=d.Protocol||"Other";protoCounts[proto]=(protoCounts[proto]||0)+1;});
      const mostUsedProtocol=Object.keys(protoCounts).sort((a,b)=>protoCounts[b]-protoCounts[a])[0]||"N/A";
      document.getElementById("totalPackets").innerText=`Total Packets: ${totalPackets}`;
      document.getElementById("normalPackets").innerText=`Normal Packets: ${normalPackets}`;
      document.getElementById("attackPackets").innerText=`Attack Packets: ${attackPackets}`;
      document.getElementById("mostUsedProtocol").innerText=`Most Used Protocol: ${mostUsedProtocol}`;
    }catch(err){console.error(err);}}

    function updateSection(data){const tbody=document.getElementById("logs");tbody.innerHTML="";
      data.forEach((d,i)=>{const row=document.createElement("tr");
        row.innerHTML=`<td>${i+1}</td><td>${d["Event ID"]||"N/A"}</td><td>${d["Source IP"]||"N/A"}</td><td>${d["Destination IP"]||"N/A"}</td><td>${d["Protocol"]||"N/A"}</td><td>${d["IDS Score"]||"N/A"}</td><td>${d["Severity"]||"Unknown"}</td>`;
        tbody.appendChild(row);});
      document.getElementById("counts").innerText=JSON.stringify(countCategories(data),null,2);
      const timestamps=data.map((d,i)=>d.Timestamp||i);
      const packetSizes=data.map(d=>d["Packet Size"]||d.packet_size||0);
      const protocols={};data.forEach(d=>{const p=d.Protocol||"Other";protocols[p]=(protocols[p]||0)+1;});
      const attackCats={};data.forEach(d=>{const c=(d.attack_cat||(d.label===0?"normal":"attack")).toLowerCase();attackCats[c]=(attackCats[c]||0)+1;});
      const severities={};data.forEach(d=>{const s=d.Severity||"Unknown";severities[s]=(severities[s]||0)+1;});
      const bins={small:0,medium:0,large:0};packetSizes.forEach(s=>{bins[s<200?"small":s<800?"medium":"large"]++;});
      updateChart("line","lineChart",timestamps,packetSizes,"Packet Size",blueShades[0],true);
      updateChart("bar","protocolChart",Object.keys(protocols),Object.values(protocols),"Count",blueShades);
      updateChart("bar","attackChart",Object.keys(attackCats),Object.values(attackCats),"Count",blueShades);
      updateChart("pie","severityChart",Object.keys(severities),Object.values(severities),"Severity",blueShades);
      updateChart("bar","sizeHistogram",Object.keys(bins),Object.values(bins),"Count",blueShades);
    }

    function updateChart(type,id,labels,data,label,color,isGradient=false){
      if(charts[id])charts[id].destroy();
      let datasetColor=color;
      if(Array.isArray(color))datasetColor=color.slice(0,data.length);
      else if(isGradient){const ctx=document.getElementById(id).getContext('2d');
        const gradient=ctx.createLinearGradient(0,0,0,400);
        gradient.addColorStop(0,'rgba(90,90,252,0.7)');
        gradient.addColorStop(1,'rgba(90,90,252,0.3)');
        datasetColor=gradient;}
      let showLegend=false;
      if(id==="lineChart"||id==="severityChart")showLegend=true;
      charts[id]=new Chart(document.getElementById(id),{type:type,data:{labels:labels,datasets:[{label:label,data:data,backgroundColor:datasetColor,borderColor:'rgba(90,90,252,0.8)',borderWidth:1,fill:type==="line"}]},options:{responsive:true,plugins:{legend:{display:showLegend,position:'top',labels:{color:'#cdd1f9',font:{size:12}}},tooltip:{enabled:true}},scales:{x:{ticks:{color:"#cdd1f9"},grid:{color:"rgba(255,255,255,0.05)"}},y:{ticks:{color:"#cdd1f9"},grid:{color:"rgba(255,255,255,0.05)"}}}}});
    }

    function countCategories(data){const counts={};data.forEach(d=>{const c=(d.attack_cat||(d.label===0?"normal":"attack")).toLowerCase();counts[c]=(counts[c]||0)+1;});return counts;}

    function downloadJSON(){const blob=new Blob([JSON.stringify(latestData,null,2)],{type:"application/json"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download="traffic_logs.json";a.click();}

    function downloadPDF(){
      const doc = new window.jspdf.jsPDF();
      let y=10;
      const now = new Date();

      doc.setFontSize(16);
      doc.text("Traffic Monitor Report",10,y); y+=10;
      doc.setFontSize(10);
      doc.text(`Generated on: ${now.toLocaleString()}`,10,y); y+=10;

      const totalPackets = latestData.length;
      const counts = countCategories(latestData);
      const normalPackets = counts.normal||0;
      const attackPackets = totalPackets-normalPackets;

      const protoCounts = {};
      latestData.forEach(d=>{ const p=d.Protocol||"Other"; protoCounts[p]=(protoCounts[p]||0)+1; });
      const mostUsedProtocol = Object.keys(protoCounts).sort((a,b)=>protoCounts[b]-protoCounts[a])[0]||"N/A";

      doc.text(`Total Packets: ${totalPackets}`,10,y); y+=6;
      doc.text(`Normal Packets: ${normalPackets}`,10,y); y+=6;
      doc.text(`Attack Packets: ${attackPackets}`,10,y); y+=6;
      doc.text(`Most Used Protocol: ${mostUsedProtocol}`,10,y); y+=10;

      doc.text("Protocol Counts:",10,y); y+=6;
      for(let k in protoCounts){ doc.text(`- ${k}: ${protoCounts[k]}`,12,y); y+=6; }

      doc.text("Attack Categories:",10,y); y+=6;
      for(let k in counts){ doc.text(`- ${k}: ${counts[k]}`,12,y); y+=6; }

      const severityCounts={};
      latestData.forEach(d=>{ const s=d.Severity||"Unknown"; severityCounts[s]=(severityCounts[s]||0)+1; });
      doc.text("Severity Levels:",10,y); y+=6;
      for(let k in severityCounts){ doc.text(`- ${k}: ${severityCounts[k]}`,12,y); y+=6; }

      const tableData = latestData.slice(-20).map((d,i)=>[
        i+1,
        d["Event ID"]||"N/A",
        d["Source IP"]||"N/A",
        d["Destination IP"]||"N/A",
        d["Protocol"]||"N/A",
        d["IDS Score"]||"N/A",
        d["Severity"]||"Unknown"
      ]);

      if(tableData.length){
        doc.autoTable({
          startY:y,
          head:[["#", "Event ID", "Src IP", "Dst IP", "Protocol", "IDS Score", "Severity"]],
          body:tableData,
          theme:'grid',
          headStyles:{fillColor:[41,128,185]},
          styles:{fontSize:8,cellPadding:2}
        });
      }
      doc.save("traffic_report.pdf");
    }

    setInterval(fetchTrafficData,5000);
    fetchTrafficData();
  </script>
</body>
</html>





